{% extends 'base.html' %}

{% block title %}{{ finca.nombre }} - Finca - Ganadek{% endblock %}
{% block breadcrumb %}

<li><i class="fas fa-chevron-right text-gray-400 mx-2"></i></li>
<li class="flex-shrink-0">
    <a href="/Fincas/" class="hover:text-green-600 transition-colors">Fincas</a>
</li>
<li><i class="fas fa-chevron-right text-gray-400 mx-2"></i></li>
<li class="text-emerald-600 font-medium">Editar Finca</li>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Form Card -->
    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
        <!-- Card Header -->
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 px-8 py-6">
            <div class="flex items-center">
                <i class="fas fa-plus-circle text-white text-3xl mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold text-white">Editar Finca</h2>
                    <p class="text-green-100">Registra los datos de tu propiedad agrícola</p>
                </div>
            </div>
        </div>

        <!-- Form Body -->
        <form id="fincaForm" method="post" enctype="multipart/form-data" class="p-8">
            {% csrf_token %}
            
            <!-- Información Básica -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                    Información Básica
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Nombre -->
                    <div class="form-group">
                        <label for="{{ form.nombre.id_for_label }}"
                            class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag text-gray-400 mr-1"></i>
                            Nombre de la Finca *
                        </label>
                        {{ form.nombre }}
                        {% if form.nombre.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.nombre.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Propietario -->
                    <div class="form-group">
                        <label for="{{ form.cedulapropietario.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user text-gray-400 mr-1"></i>
                            Cédula del Propietario
                        </label>
                      {{form.cedulapropietario}}
                        {% if form.cedulapropietario.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.cedulapropietario.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Ubicación -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                    Ubicación
                </h3>

                <div class="grid grid-cols-1 gap-6">
                    <!-- Ubicación -->
                    <div class="form-group">
                        <label for="{{ form.ubicacion.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-location-dot text-gray-400 mr-1"></i>
                            Dirección/Ubicación
                        </label>
                        {{ form.ubicacion }}
                        {% if form.ubicacion.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.ubicacion.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Coordenadas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="{{ form.latitud.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-compass text-gray-400 mr-1"></i>
                                Latitud
                            </label>
                           {{ form.latitud }}
                            {% if form.latitud.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.latitud.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.longitud.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-compass text-gray-400 mr-1"></i>
                                Longitud
                            </label>
                            {{ form.longitud }}
                            {% if form.longitud.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.longitud.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Botón para obtener ubicación -->
                    <div class="flex justify-center">
                        <button type="button" id="getLocationBtn"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition duration-200 flex items-center">
                            <i class="fas fa-crosshairs mr-2"></i>
                            Obtener mi ubicación actual
                        </button>
                    </div>
                </div>
            </div>

            <!-- Características -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-seedling text-green-500 mr-2"></i>
                    Características de la Finca
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Hectáreas -->
                    <div class="form-group">
                        <label for="hectareas" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-ruler-combined text-gray-400 mr-1"></i>
                            Hectáreas
                        </label>
                     {{ form.hectareas }}
                        {% if form.hectareas.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.hectareas.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Fuente de Agua -->
                    <div class="form-group">
                        <label for="{{ form.id_for_label }} ="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tint text-gray-400 mr-1"></i>
                            Fuente de Agua
                        </label>
                        {{ form.fuenteagua }}
                        {% if form.fuenteagua.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.fuenteagua.errors.0 }}</div>
                        {% endif %}
                        
                    </div>

                    <!-- Estado -->
                    <div class="form-group">
                        <label for="{{ form.estado.id_for_label}}" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-check-circle text-gray-400 mr-1"></i>
                            Estado
                        </label>
                        {{ form.estado }}
                        {% if form.estado.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.estado.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Explotación -->
                <div class="mt-6">
                    <div class="form-group">
                        <label for="{{form.explotacion.id_form_label}}" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-leaf text-gray-400 mr-1"></i>
                            Tipo de Explotación
                        </label>
                        {{ form.explotacion }}
                        {% if form.explotacion.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.explotacion.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div
                class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4 pt-6 border-t border-gray-200">

               <a href="/Fincas/"> 
                <button type="button" id="cancelBtn" 
                    class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200 flex items-center justify-center">
                    <i class="fas fa-times mr-2"></i>
                    Cancelar
                </button>
            </a>

                <button type="button" id="previewBtn"
                    class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 flex items-center justify-center">
                    <i class="fas fa-eye mr-2"></i>
                    Vista Previa
                </button>


                <button type="submit"
                    class="px-8 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 transition duration-200 flex items-center justify-center shadow-lg">
                    <i class="fas fa-save mr-2"></i>
                    Editar Finca
                </button>
            </div>

        </form>
    </div>
</div>
</main>

<!-- Modal de Vista Previa -->
<div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-96 overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-eye text-blue-500 mr-2"></i>
                Vista Previa de la Finca
            </h3>
        </div>
        <div id="previewContent" class="p-6">
            <!-- Content will be filled by JavaScript -->
        </div>
        <div class="p-6 border-t border-gray-200 flex justify-end">
            <button id="closePreviewBtn"
                class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200">
                Cerrar
            </button>
        </div>
    </div>
</div>

<!-- Success Toast -->
<div id="successToast"
    class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
    <div class="flex items-center">
        <i class="fas fa-check-circle mr-2"></i>
        <span>Finca creada exitosamente!</span>
    </div>
</div>

<script>
    // Obtener ubicación actual
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('getLocationBtn').addEventListener('click', function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    document.getElementById('latitud').value = position.coords.latitude.toFixed(6);
                    document.getElementById('longitud').value = position.coords.longitude.toFixed(6);
                    showToast('Ubicación obtenida correctamente', 'success');
                }, function (error) {
                    showToast('Error al obtener la ubicación: ' + error.message, 'error');
                });
            } else {
                showToast('La geolocalización no está soportada en este navegador', 'error');
            }
        });
    });


    // Vista previa
    document.getElementById('previewBtn').addEventListener('click', function () {
        const formData = new FormData(document.getElementById('fincaForm'));
        let previewHTML = '<div class="grid grid-cols-2 gap-4 text-sm">';

        const fieldLabels = {
            'nombre': 'Nombre',
            'cedulapropietario': 'Cédula Propietario',
            'ubicacion': 'Ubicación',
            'latitud': 'Latitud',
            'longitud': 'Longitud',
            'hectareas': 'Hectáreas',
            'fuenteagua': 'Fuente de Agua',
            'explotacion': 'Tipo de Explotación',
            'estado': 'Estado'
        };

        for (let [key, value] of formData.entries()) {
            if (value && fieldLabels[key]) {
                previewHTML += `
                        <div>
                            <strong class="text-gray-600">${fieldLabels[key]}:</strong>
                            <span class="text-gray-800">${value}</span>
                        </div>
                    `;
            }
        }

        previewHTML += '</div>';

        if (previewHTML === '<div class="grid grid-cols-2 gap-4 text-sm"></div>') {
            previewHTML = '<p class="text-gray-500 text-center">No hay datos para mostrar</p>';
        }

        document.getElementById('previewContent').innerHTML = previewHTML;
        document.getElementById('previewModal').classList.remove('hidden');
    });

    // Cerrar modal de vista previa
    document.getElementById('closePreviewBtn').addEventListener('click', function () {
        document.getElementById('previewModal').classList.add('hidden');
    });

    // Cerrar modal al hacer clic fuera
    document.getElementById('previewModal').addEventListener('click', function (e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });
  

    // Cancelar formulario
    document.getElementById('cancelBtn').addEventListener('click', function () {
        if (confirm('¿Estás seguro de que quieres cancelar? Se perderán todos los datos ingresados.')) {
            document.getElementById('fincaForm').reset();
            showToast('Formulario cancelado', 'info');
            
        }
    });

    // Función para mostrar toast
    function showToast(message, type = 'info') {
        const toast = document.getElementById('successToast');
        const colors = {
            'success': 'bg-green-500',
            'error': 'bg-red-500',
            'info': 'bg-blue-500'
        };

        toast.className = `fixed top-4 right-4 text-white px-6 py-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50 ${colors[type] || colors.info}`;
        toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

        // Mostrar toast
        toast.classList.remove('translate-x-full');

        // Ocultar después de 3 segundos
        setTimeout(() => {
            toast.classList.add('translate-x-full');
        }, 3000);
    }

    // Animaciones de entrada para los campos del formulario
    const formGroups = document.querySelectorAll('.form-group');
    formGroups.forEach((group, index) => {
        group.style.opacity = '0';
        group.style.transform = 'translateY(20px)';

        setTimeout(() => {
            group.style.transition = 'all 0.5s ease-out';
            group.style.opacity = '1';
            group.style.transform = 'translateY(0)';
        }, index * 100);
    });
</script>
{% endblock %}